#!/bin/bash

readonly OPENSCAD="/Applications/OpenSCAD.app/Contents/MacOS/OpenSCAD"
GREATER_THAN="-gt"

action="$1"
if [ -e ".osc-data" ]
then
  project_file=$(cat .osc-data)
fi

function die_with_message
{
  echo $1;
  exit 1
}

case "$1" in
  start)
    if [ ! -z "$2" ]
    then
      new_project_file="$2"
      mkdir -pv $(dirname "$new_project_file")
      echo $new_project_file > .osc-data
      touch $new_project_file".scad"
      exit 0
    else
      die_with_message "Usage: openscad start filename (Inlude the path, but not the extension)"
    fi
  ;;
  check)
    # 2>&1 takes it from STDERR to STDOUT
    "$OPENSCAD" --hardwarnings -o "preview.png" "$project_file.scad"
    result=$("$OPENSCAD" --hardwarnings -o "preview.png" "$project_file.scad" 2>&1)
    case "$result" in
      *WARNING*)
        die_with_message "Failed."
        ;;
      *ERROR*)
        die_with_message "Failed."
        ;;
    esac
    echo "All good."
  ;;
  info)
    "$OPENSCAD" --info "$project_file.scad"
    exit 0
  ;;
  preview)
    rm preview.png
    "$OPENSCAD" --hardwarnings -o "preview.png" "$project_file.scad"
    kitty +kitten icat preview.png
    exit 0
  ;;
  render)
    "$OPENSCAD" --hardwarnings -o "$project_file.stl" "$project_file.scad"
    exit 0
  ;;
  *)
    die_with_message "That's not a recognized command."
esac
