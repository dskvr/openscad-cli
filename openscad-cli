#!/bin/bash

readonly OPENSCAD="/Applications/OpenSCAD.app/Contents/MacOS/OpenSCAD"
GREATER_THAN="-gt"

function die_with_message
{
  echo $1;
  exit 1
}

action="$1"
if [ ! -z $2 ]
then
  project_file=$2
elif [ -e ".osc-data" ]
then
    project_file=$(cat .osc-data)
else
    die_with_message "There's nothing in progress. Specify a work file.."
fi

echo "--"
echo "$project_file"

function check_file_for_errors 
{
  local temp=$(mktemp XXXXXX.png)
  local result=$("$OPENSCAD" --hardwarnings -o "$temp" "$1" 2>&1)
  rm "$temp"
  case "$result" in
    *WARNING*)
      echo $result
      echo "Failed with warnings."
      return 1
      ;;
    *ERROR*)
      echo $result
      echo "Failed with errors."
      return 1
      ;;
  esac
  return 0
}

case "$1" in
  start)
    mkdir -pv $(dirname "$project_file")
    echo $project_file > .osc-data
    touch $project_file".scad"
    exit 0
  ;;
  check)
    check_file_for_errors "$project_file.scad"
    result=$?
    if [ $result -eq 0 ] 
    then
      echo "File checks out."
    else
      exit 1
    fi
  ;;
  info)
    "$OPENSCAD" --info "$project_file.scad"
    exit 0
  ;;
  preview)
    check_file_for_errors "$project_file.scad"
    if [ $? -ne 0 ]
    then
      exit 1
    fi
    rm preview.png
    "$OPENSCAD" --hardwarnings -o "preview.png" "$project_file.scad"
    kitty +kitten icat preview.png
    exit 0
  ;;
  render)
    "$OPENSCAD" --hardwarnings -o "$project_file.stl" "$project_file.scad"
    exit 0
  ;;
  *)
    die_with_message "That's not a recognized command."
esac
