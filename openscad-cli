#!/bin/bash

readonly OPENSCAD="/Applications/OpenSCAD.app/Contents/MacOS/OpenSCAD"
GREATER_THAN="-gt"

action="$1"
project_file="$(cat .osc-data)"
new_project_file="$2"

function die_with_message
{
  echo $1;
  exit 1
}

while [ $# $GREATER_THAN 0 ]; do
  case "$1" in
    start)
      if [ -z "$2" ]
      then
        die_with_message "You need to specify what you want to work on. Use a filename, including path but not extension."
      elif [ ! -z "$3" ]
      then
        die_with_message "That's too many parameters."
      else
        mkdir -p $(dirname $new_project_file)
        echo $new_project_file > .osc-data
        touch $new_project_file".scad"
        exit
      fi
    ;;
    info)
      "$OPENSCAD" --info "$project_file.scad"
    ;;
    preview)
      rm preview.png
      "$OPENSCAD" --hardwarnings -o "preview.png" "$project_file.scad"
      kitty +kitten icat preview.png
    ;;
    render)
      "$OPENSCAD" --hardwarnings -o "$project_file.stl" "$project_file.scad"
      exit 0 
    ;;
    *)
      die_with_message "That's not a recognized command."
  esac
  shift
done
