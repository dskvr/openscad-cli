#!/bin/bash

readonly OPENSCAD="/Applications/OpenSCAD.app/Contents/MacOS/OpenSCAD"

SUCCESS=0
FAIL=1
OSC_ERROR=2
OSC_WARNING=3

function die_with_message
{
  message=$1
  echo $message
  exit $FAIL
}

function check_for_OpenSCAD_errors 
{
  # 2>&1, below, means send stderr to stdout
  local result=$("$OPENSCAD" --hardwarnings -o .osc-data/filecheck.png "$1" 2>&1)
  case "$result" in
    *WARNING*)
      echo "$result"
      return $OSC_WARNING
      ;;
    *ERROR*)
      echo "$result"
      return $OSC_ERROR
      ;;
  esac
  return 0
}

function start_action
{
  clean_action
  local new_work_file=$1
  mkdir -pv $(dirname "$new_work_file")
  touch $new_work_file".scad"
  mkdir -p ".osc-data"
  echo $new_work_file > ".osc-data/working_file"
  return 0
}

function check_action
{
  # local can't go on the assignment because local exits with 0 so no test happens
  local work_file
  work_file="$(memory)"
  if (( $? == $FAIL ))
  then
    die_with_message "$work_file"
  fi
  check_for_OpenSCAD_errors "$work_file.scad"
  local result=$?
  if (( result == OSC_WARNING ))
  then
    echo "Failed with warnings."
    return $FAIL
  elif (( $result == $OSC_ERROR ))
  then
    echo "Failed with errors."
    return $FAIL
  else
    echo "No errors found."
    return $SUCCESS
  fi
}

function clean_action
{
  rm -rf .osc-data
}

function info_action
{
  # "$OPENSCAD" --info "$work_file.scad"
  # exit 0
  :
}

function preview_action
{
  if ! check_action
  then
    return $FAIL
  fi
  "$OPENSCAD" --hardwarnings -o ".osc-data/preview.png" "$(memory).scad"
  kitty +kitten icat ".osc-data/preview.png"
  return $SUCCESS
}

function render_action
{
  if ! preview_action
  then
    return $FAIL
  fi
  local working_file=$(memory)
  "$OPENSCAD" --hardwarnings -o "$working_file.stl" "$working_file.scad"
  return $SUCCESS
}

function memory
{
  if [ -e ".osc-data/working_file" ]
  then
    cat .osc-data/working_file
    return $SUCCESS
  else
    die_with_message "There's nothing in progress. You'll need to start a new work file."
  fi
}

action="$1"
shift
case $action in
  start)
    start_action "$@"
  ;;
  clean)
    clean_action
  ;;
  check)
    check_action
  ;;
  info)
    info_action
  ;;
  preview)
    preview_action
  ;;
  render)
    render_action
  ;;
  *)
    die_with_message "That's not a recognized command."
esac
